
<!doctype html>
<meta charset=utf8>
<meta name="viewport" id="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0">
<script src="resources/lib/codemirror/lib/codemirror.js"></script>
<link rel=stylesheet href="resources/lib/codemirror/lib/codemirror.css">
<script src="resources/mode/mediawiki/mediawiki.js"></script>
<link rel=stylesheet href="resources/mode/mediawiki/mediawiki.css">

<style>
  
  body {
    margin: 0;
  }
  
  .CodeMirror, textarea#editor {
    height: 100vh;
    width: 100%;
    -webkit-overflow-scrolling: touch;
    box-sizing: border-box;
  }
  
  textarea#editor {
    padding: 4px 0px 4px 31px;
    border: none;
    font-family: monospace;
    font-size: 13px;
  }
  
</style>

<body>
  
  <textarea id=editor></textarea>


  <!--TODO: load config by lang as needed-->
  <script>
  let config
  </script>
  <script src="codemirror-config.js" ></script>


  <script>

    
    let editor
    let editorTextArea = document.getElementById("editor")
    let codeMirrorSettings = {
      mwConfig: config,
      lineWrapping: true,
      lineNumbers: true,
      mode: "text/mediawiki",
      matchBrackets: true,
      extraKeys: {
        // t.b.d.
      }, 
      inputStyle: 'contenteditable',
      spellcheck: false,
      viewportMargin: Infinity
    }

    const EditorType = {
      notset: 0,
      codemirror: 1,
      wikitext: 2
    }

    let currentEditorType = EditorType.notset

    const showWikitext = () => {
      editor.toTextArea()
      editorTextArea.style.display = 'block'
      currentEditorType = EditorType.wikitext
    }

    const showCodemirror = () => {
      editor = CodeMirror.fromTextArea(editorTextArea, codeMirrorSettings)
      editorTextArea.style.display = 'hidden'
      currentEditorType = EditorType.codemirror
    }
    
    const wmf = {}
    
    wmf.EditorType = EditorType
    
    wmf.getWikitext = () => {
      switch(currentEditorType) {
        case EditorType.codemirror:
          return editor.getValue()  
        case EditorType.wikitext:
          return editorTextArea.value
      }
    }

    wmf.setWikitext = (wikitext) => {
      switch(currentEditorType) {
        case EditorType.codemirror:
          editor.setValue(wikitext)
          break
        case EditorType.notset:
        case EditorType.wikitext:
          editorTextArea.value = wikitext
          break
      }
    }

    wmf.setCurrentEditorType = (type) => {
      currentEditorType = type
    }

    wmf.update = () => {
      switch(currentEditorType) {
        case EditorType.codemirror:
          showCodemirror()
          break
        case EditorType.notset:
        case EditorType.wikitext:
          showWikitext()
          break
      }
    }

    wmf.ExecCommandType = {
      cursorUp: 'goLineUp',
      cursorDown: 'goLineDown',
      cursorLeft: 'goCharLeft',
      cursorRight: 'goCharRight',
      undo: 'undo',
      redo: 'redo'
    }

    wmf.execCommand = (execCommandType) => {
      editor.execCommand(execCommandType)
    }

    window.wmf = wmf

  </script>
</body>